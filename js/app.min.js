"use strict";angular.module("app",["ngAnimate","ngSanitize","ngMessages","ngMap","firebase","ui.router","ngMaterial","ngStorage","ngAria","lfNgMdFileInput","textAngular","md.data.table","slugifier","angularMoment"]),angular.module("app").config(["$mdThemingProvider","$logProvider","$locationProvider",function($mdThemingProvider,$logProvider,$locationProvider){$logProvider.debugEnabled(!0),$locationProvider.html5Mode(!1),$mdThemingProvider.theme("red").primaryPalette("red").accentPalette("orange"),$mdThemingProvider.theme("default").primaryPalette("blue").accentPalette("indigo")}]),angular.module("app").constant("loginRedirectPath","admin.login").constant("allowedOfflineStates",["admin.login","admin.register","home","donate","deliver","admin.logout","chooseDonation","chooseCenter"]).constant("adminStates",["admin.volunteers","admin.donations"]).constant("FB_CONFIG",{apiKey:"AIzaSyDR-aACSORClSwkE0CcZs8aAmKawIKDYH8",authDomain:"acopio-en-bici.firebaseapp.com",databaseURL:"https://acopio-en-bici.firebaseio.com",projectId:"acopio-en-bici",storageBucket:"acopio-en-bici.appspot.com",messagingSenderId:"669726958713"}),angular.module("app").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("home",{url:"/inicio",templateUrl:"partials/home/index.html",controller:"HomeCtrl"}).state("donate",{url:"/donar",templateUrl:"partials/home/donate.html",controller:"DonateCtrl"}).state("deliver",{url:"/entregar",templateUrl:"partials/home/volunteer.html",controller:"VolunteerCtrl"}).state("chooseDonation",{url:"/selecciona-donacion",templateUrl:"partials/home/1-choose-donation.html",controller:"ChooseDonationCtrl"}).state("chooseCenter",{url:"/selecciona-centro-de-acopio",templateUrl:"partials/home/2-choose-center.html",controller:"ChooseCenterCtrl"}).state("admin",{url:"/admin",templateUrl:"partials/admin/index.html",controller:"AdminCtrl"}).state("admin.login",{url:"/login",templateUrl:"partials/admin/login.html",controller:"AdminLoginCtrl"}).state("admin.donations",{url:"/donaciones",templateUrl:"partials/admin/donations.html",controller:"AdminDonationsCtrl"}).state("admin.volunteers",{url:"/voluntarios",templateUrl:"partials/admin/volunteers.html",controller:"AdminVolunteersCtrl"}).state("admin.centers",{url:"/centros-de-acopio",templateUrl:"partials/admin/centers.html",controller:"AdminCentersCtrl"}).state("admin.main",{url:"/main",templateUrl:"partials/admin/main.html",controller:"AdminMainCtrl"}).state("admin.logout",{url:"/login",templateUrl:"partials/admin/logout.html",controller:"AdminLogoutCtrl"}).state("admin.register",{url:"/registro",templateUrl:"partials/admin/register.html",controller:"AdminRegisterCtrl"}),$urlRouterProvider.otherwise("/inicio")}]),angular.module("app").run(["$rootScope","$state","$log","$location","$localStorage","$timeout","FB_CONFIG","allowedOfflineStates","adminStates","loginRedirectPath","AppF","$firebaseObject",function($rootScope,$state,$log,$location,$localStorage,$timeout,config,states,adminStates,loginRedirectPath,F,$firebaseObject){function check(user){c++,$log.debug(user,c),F.user=user,angular.isObject(user)?(F.user.providerData&&"twitter.com"==F.user.providerData[0].providerId&&firebase.database().ref("/volunteers").child(user.uid).once("value",function(snap){var profile=snap.val();profile&&(F.userProfile=profile)}),$rootScope.$broadcast("loggedIn",!0)):(isPermitted($state.current.name)||$state.go(loginRedirectPath),$log.debug(user,loginRedirectPath,$state.current,"User Not Logged"))}function isPermitted(route){var isPermitted=states.indexOf(route)!==-1;return route||(isPermitted=!0),isPermitted}function isAdmin(route){var isAdmin=adminStates.indexOf(route)!==-1;return route||(isPermitted=!0),isAdmin}firebase.initializeApp(config),F.auth=firebase.auth(),F.auth.onAuthStateChanged(check),$rootScope.$on("$stateChangeStart",function(e,toState,toParams,fromState,fromParams){F.user?checkAdmin(toState.name,e):isPermitted(toState.name)||($log.debug(F.user,loginRedirectPath,$state.current.name,"YES"),$localStorage.lastPage=toState.name,$state.go(loginRedirectPath),e.preventDefault())});var checkAdmin=function(route,e){isAdmin(route)&&(console.log(F.auth,"AUTH"),"twitter.com"==F.user.providerData[0].providerId&&($state.go("home"),$log.error("No tienes permiso para entrar a esta ruta"),e.preventDefault()))};$rootScope.$on("$stateChangeError",function(event,toState,toParams,fromState,fromParams,error){"AUTH_REQUIRED"===error&&$state.go("home")});var c=1}]),angular.module("app").controller("AdminCentersCtrl",["$rootScope","$scope","errAlertS","successAlertS","$firebaseArray","AppF","$log",function($rootScope,$scope,errAlertS,successAlertS,$firebaseArray,F,$log){var initiated=!1,root=firebase.database().ref("/");$scope.centers=[],$scope.currentPage=1,$scope.selected=[];var init=function(){initiated=!0,$scope.centers=$firebaseArray(root.child("centers")),$log.debug("Donation Ctrl initiated")};$scope.save=function(center){$log.debug("saving",center),center.updatedAt=moment().valueOf(),center.updatedBy=F.user.uid,$scope.centers.$save(center).then(function(){successAlertS("Se guardó registro")},errAlertS)},$scope.activate=function(center){$log.debug("activate",center),center.active=!0,$scope.save(center)},$scope.deactivate=function(center){$log.debug("deactivate",center),center.active=!1,$scope.save(center)},$scope.remove=function(center){return $log.debug("removing: ",center),$scope.centers.$remove(center)},$scope.showRemoveDialog=function(ev){$mdDialog.show($mdDialog.confirm({onComplete:function(){var $dialog=angular.element(document.querySelector("md-dialog")),$actionsSection=$dialog.find("md-dialog-actions"),$cancelButton=$actionsSection.children()[0],$confirmButton=$actionsSection.children()[1];angular.element($confirmButton).addClass("md-raised md-warn"),angular.element($cancelButton).addClass("md-raised")}}).title("Remover "+$scope.selected.length+" centros de acopio?").textContent("No podrá recuperar los datos").ariaLabel("Lucky day").targetEvent(event).ok("Eliminar").cancel("Cancelar")).then(function(){var count=0;$log.debug("Deleting: ",$scope.selected),angular.forEach($scope.selected,function(record){$scope.remove(record).then(function(){count==$scope.selected.length&&(successAlert("Se borraron "+count+" centros de acopio"),$scope.selected=[])})})})},$rootScope.$on("loggedIn",function(event,logged){$log.debug(logged,"loggedIn?"),logged&&!initiated&&init()}),F.user&&!initiated&&init()}]),angular.module("app").controller("AdminCtrl",["$rootScope","$scope","$firebaseObject","$firebaseArray","$state","$log","AppF",function($rootScope,$scope,$firebaseObject,$firebaseArray,$state,$log,F){var initiated=!1,init=function(){firebase.database().ref("/");$log.debug("AdminCtrl Loaded"),F.inModule="admin"};$rootScope.$on("loggedIn",function(event,logged){$log.debug(logged,"loggedIn?"),logged&&init()}),F.user&&!initiated&&init()}]),angular.module("app").controller("AdminDonationsCtrl",["$rootScope","$scope","errAlertS","successAlertS","$firebaseArray","AppF","$log","$mdDialog",function($rootScope,$scope,errAlertS,successAlertS,$firebaseArray,F,$log,$mdDialog){var initiated=!1,root=firebase.database().ref("/");$scope.donations=[],$scope.currentPage=1,$scope.selected=[];var init=function(){initiated=!0,$scope.donations=$firebaseArray(root.child("donations")),$log.debug("Donation Ctrl initiated")};$scope.save=function(donation){$log.debug("saving",donation),donation.updatedAt=moment().valueOf(),donation.updatedBy=F.user.uid,$scope.donations.$save(donation).then(function(){successAlertS("Se guardó registro")},errAlertS)},$scope.pickup=function(donation){$log.debug("picked up",donation),donation.pickedUp=!0,$scope.save(donation)},$scope.cancelPickup=function(donation){$log.debug("cancel picked up",donation),donation.pickedUp=!1,$scope.save(donation)},$scope.remove=function(donation){return $log.debug("removing: ",donation),$scope.donations.$remove(donation)},$scope.showRemoveDialog=function(ev){$mdDialog.show($mdDialog.confirm({onComplete:function(){var $dialog=angular.element(document.querySelector("md-dialog")),$actionsSection=$dialog.find("md-dialog-actions"),$cancelButton=$actionsSection.children()[0],$confirmButton=$actionsSection.children()[1];angular.element($confirmButton).addClass("md-raised md-warn"),angular.element($cancelButton).addClass("md-raised")}}).title("Remover "+$scope.selected.length+" donaciones?").textContent("No podrá recuperar los datos").ariaLabel("Lucky day").targetEvent(event).ok("Eliminar").cancel("Cancelar")).then(function(){var count=0;$log.debug("Deleting: ",$scope.selected),angular.forEach($scope.selected,function(record){$scope.remove(record).then(function(){count==$scope.selected.length&&(successAlert("Se borraron "+count+" donaciones"),$scope.selected=[])})})})},$rootScope.$on("loggedIn",function(event,logged){$log.debug(logged,"loggedIn?"),logged&&!initiated&&init()}),F.user&&!initiated&&init()}]),angular.module("app").controller("AdminLoginCtrl",["$rootScope","$scope","$firebaseAuth","$state","$log","AppF","successAlertS","errAlertS",function($rootScope,$scope,$firebaseAuth,$state,$log,AppF,successAlert,errAlert){$scope.auth=$firebaseAuth(),$scope.admin={};var root=firebase.database().ref("/");$scope.login=function(){AppF.loading=!0,$log.debug("login",$scope.admin),root.child("users").orderByChild("email").equalTo($scope.admin.email).once("value",function(snap){var usersFromDB=snap.val();if(console.log(usersFromDB,"userR"),usersFromDB)for(var uid in usersFromDB){var userFromDB=usersFromDB[uid];console.log(userFromDB,"user"),userFromDB.active?$scope.auth.$signInWithEmailAndPassword($scope.admin.email,$scope.admin.password).then(function(user){AppF.user=user,successAlert("Bienvenid@"),$state.go("admin.main")})["catch"](function(err){errAlert(err),AppF.loading=!1}):(errAlert("Usuario no activado"),AppF.loading=!1)}else errAlert("Usuario no existente"),AppF.loading=!1})},$rootScope.$on("loggedIn",function(event,logged){logged&&$state.go("admin.donations")}),$rootScope.$watch("F.user",function(user){user&&$state.go("admin.donations")})}]),angular.module("app").controller("AdminLogoutCtrl",["$scope","$firebaseAuth","$log","errAlertS","AppF","$localStorage","$state",function($scope,$firebaseAuth,$log,errAlert,F,$localStorage,$state){var logout=function(){$log.debug("Bye"),firebase.auth().signOut().then(function(){firebase.database().goOffline(),F.user=!1,$localStorage.lastPage=null,$state.go("home")},errAlert)};logout()}]),angular.module("app").controller("AdminMainCtrl",["$rootScope","$scope","$log","AppF",function($rootScope,$scope,$log,F){var initiated=!1,init=function(){initiated=!0};$rootScope.$on("loggedIn",function(event,logged){$log.debug(logged,"loggedIn?"),logged&&!initiated&&init()}),F.user&&!initiated&&init()}]),angular.module("app").controller("AdminRegisterCtrl",["$rootScope","$scope","$firebaseAuth","$state","$log","AppF","successAlertS","errAlertS",function($rootScope,$scope,$firebaseAuth,$state,$log,AppF,successAlert,errAlert){$scope.auth=$firebaseAuth(),$scope.admin={};var root=firebase.database().ref("/");$scope.register=function(){AppF.loading=!0,$log.debug("register",$scope.credentials),$scope.auth.$createUserWithEmailAndPassword($scope.admin.email,$scope.admin.password).then(function(user){$scope.saveProfile(user.uid).then(function(){successAlert("Se creo el usuario, en cuanto sea aprobado por administración, podras entrar."),$state.go("admin.logout")},function(err){errAlert(err),AppF.loading=!1})})["catch"](function(err){errAlert(err),AppF.loading=!1})},$scope.saveProfile=function(uid){console.log("saveProfile",user,$scope.admin);var user=$scope.admin;return user.active=!1,user.uid=uid,root.child("users").child(uid).set(user)}}]),angular.module("app").controller("AdminVolunteersCtrl",["$rootScope","$scope","errAlertS","successAlertS","$firebaseArray","AppF","$log",function($rootScope,$scope,errAlertS,successAlertS,$firebaseArray,F,$log){var initiated=!1,root=firebase.database().ref("/");$scope.volunteers=[],$scope.currentPage=1,$scope.selected=[];var init=function(){initiated=!0,$scope.volunteers=$firebaseArray(root.child("volunteers")),$log.debug("Donation Ctrl initiated")};$scope.save=function(volunteer){$log.debug("saving",volunteer),volunteer.updatedAt=moment().valueOf(),volunteer.updatedBy=F.user.uid,$scope.volunteers.$save(volunteer).then(function(){successAlertS("Se guardó registro")},errAlertS)},$scope.activate=function(volunteer){$log.debug("activate",volunteer),volunteer.active=!0,$scope.save(volunteer)},$scope.deactivate=function(volunteer){$log.debug("deactivate",volunteer),volunteer.active=!1,$scope.save(volunteer)},$scope.remove=function(volunteer){return $log.debug("removing: ",volunteer),$scope.volunteers.$remove(volunteer)},$scope.showRemoveDialog=function(ev){$mdDialog.show($mdDialog.confirm({onComplete:function(){var $dialog=angular.element(document.querySelector("md-dialog")),$actionsSection=$dialog.find("md-dialog-actions"),$cancelButton=$actionsSection.children()[0],$confirmButton=$actionsSection.children()[1];angular.element($confirmButton).addClass("md-raised md-warn"),angular.element($cancelButton).addClass("md-raised")}}).title("Remover "+$scope.selected.length+" voluntarios?").textContent("No podrá recuperar los datos").ariaLabel("Lucky day").targetEvent(event).ok("Eliminar").cancel("Cancelar")).then(function(){var count=0;$log.debug("Deleting: ",$scope.selected),angular.forEach($scope.selected,function(record){$scope.remove(record).then(function(){count==$scope.selected.length&&(successAlert("Se borraron "+count+" voluntarios"),$scope.selected=[])})})})},$rootScope.$on("loggedIn",function(event,logged){$log.debug(logged,"loggedIn?"),logged&&!initiated&&init()}),F.user&&!initiated&&init()}]),angular.module("app").controller("ChooseCenterCtrl",["$rootScope","$scope","$log","successAlertS","errAlertS","$firebaseAuth","$state","$q","AppF","$firebaseArray","NgMap","$document","geoDistanceFilter",function($rootScope,$scope,$log,successAlertS,errAlertS,$firebaseAuth,$state,$q,F,$firebaseArray,NgMap,$document,geoDistanceFilter){var initiated=!1;$scope.volunteer={};var root=firebase.database().ref("/");$scope.auth=$firebaseAuth(),$scope.distanceFromMe=10,$scope.distanceForCenters=100,$scope.selectedDonation=!1,$scope.selectedCenter=!1,$scope.map,$scope.loading=!0;var init=function(user){user&&user.providerData&&user.providerData[0]&&"twitter.com"==user.providerData[0].providerId&&(console.log(user,"loggedIn User"),checkIfUserExist(user.uid).then(function(volunteer){volunteer?(console.log(volunteer,"volunteer existe"),$scope.volunteer=volunteer,$scope.volunteer.hasOwnProperty("selectedDonation")?(getSelectedDonation($scope.volunteer.selectedDonation),getMapInfo()):$state.go("chooseDonation")):($scope.volunteer={registeredTovolunteer:!1,provider:"twitter",uid:user.uid,active:!1},console.log($scope.volunteer,"volunteer no existe")),initiated=!0}))},saveDonation=function(donation,successMsg){var promise=$q.defer();donation.updatedAt=moment().valueOf();var id=angular.copy(donation.$id);return delete donation.$id,delete donation.$priority,delete donation.distance,console.log(donation,id,"saving donation"),root.child("donations").child(id).set(donation).then(function(){donation.$id=id,successAlertS(successMsg),promise.resolve(!0)},function(err){errAlertS(err),promise.reject(err)}),promise.promise},saveVolunteer=function(value,prop){return console.log(value,prop,"saving volunteer"),root.child("volunteers").child(F.user.uid).child(prop).set(value)},checkIfUserExist=function(uid){var promise=$q.defer();return root.child("volunteers").child(uid).once("value",function(snap){var volunteer=snap.val();volunteer?promise.resolve(volunteer):promise.resolve(!1)},function(err){errAlertS(err),promise.reject(err)}),promise.promise},getSelectedCenter=function(centerId){console.log("getSelectedCenter",centerId),root.child("centers").child(centerId).once("value",function(snap){$scope.selectedCenter=snap.val(),$scope.selectedCenter.$id=snap.key,$scope.$apply()})},getSelectedDonation=function(donationId){console.log("getSelectedDonation",donationId),root.child("donations").child(donationId).once("value",function(snap){$scope.selectedDonation=snap.val(),$scope.selectedDonation.$id=snap.key,$scope.$apply(),"esperando"==$scope.selectedDonation.status||"recogiendo"==$scope.selectedDonation.status?$state.go("chooseDonation"):$scope.selectedDonation.hasOwnProperty("deliverAt")&&getSelectedCenter($scope.selectedDonation.deliverAt)})},addMarker=function(lat,lng,name,place){var marker=new google.maps.Marker({position:new google.maps.LatLng(lat,lng),map:$scope.map,title:name});google.maps.event.addListener(marker,"click",function(){$scope.selectCenter(place)})},initMap=function(){F.getLocation().then(function(myPosition){var latlng=new google.maps.LatLng(myPosition.latitude,myPosition.longitude),myOptions={zoom:14,center:latlng,mapTypeId:google.maps.MapTypeId.TERRAIN};$scope.map=new google.maps.Map(document.getElementById("map"),myOptions),$scope.nearestCenters=$scope.centersAvailable,console.log($scope.nearestCenters,"DAMN");for(var d in $scope.nearestCenters){var center=$scope.nearestCenters[d];center.hasOwnProperty("$id")&&addMarker(center.geometry.coordinates[1],center.geometry.coordinates[0],center.properties.Name,center)}$scope.loading=!1,google.maps.event.addListenerOnce($scope.map,"idle",function(){google.maps.event.trigger($scope.map,"resize"),$scope.map.setCenter(latlng)})})},getMapInfo=function(){$scope.centersAvailable=$firebaseArray(root.child("centers")),$scope.centersAvailable.$loaded().then(function(){initMap()})};$scope.deliverDonation=function(){$scope.selectedDonation.status="entregado",$scope.selectedDonation.deliveredBy=F.user.uid,saveVolunteer(null,"selectedDonation").then(function(){saveDonation($scope.selectedDonation,"Gracias!! Se entrego la donación correctamente!").then(function(){$state.go("chooseDonation")})})},$scope.cancelPickup=function(){$scope.selectedDonation.status="esperando",$scope.selectedDonation.deliverAt=null,saveVolunteer(null,"selectedDonation").then(function(){saveDonation($scope.selectedDonation,"Se canceló que recogieras esa donación").then(function(){$scope.selectedDonation=!1,$state.go("chooseDonation")})})},$scope.selectCenter=function(point){console.log(point,"select point"),$scope.loading=!0,$scope.selectedCenter=point,$scope.selectedDonation.status="entregando",$scope.selectedDonation.deliverAt=$scope.selectedCenter.$id,saveVolunteer($scope.selectedDonation.$id,"selectedDonation").then(function(){saveDonation($scope.selectedDonation,"Escogiste un centro").then(function(){$scope.loading=!1})})},NgMap.getMap("map").then(function(evtMap){$scope.map=evtMap}),$rootScope.$on("loggedIn",function(event,logged){$log.debug(logged,"loggedIn?"),logged&&!initiated&&("twitter.com"!==F.user.providerData[0].providerId?$state.go("home"):init(F.user))}),F.user&&!initiated&&("twitter.com"!==F.user.providerData[0].providerId?$state.go("home"):init(F.user));var initWatcher=$scope.$watch("F.user.providerData[0].providerId",function(providerId){providerId&&("twitter.com"!==providerId?$state.go("home"):initiated||(init(F.user),initWatcher()))})}]),angular.module("app").controller("ChooseDonationCtrl",["$rootScope","$scope","$log","successAlertS","errAlertS","$firebaseAuth","$state","$q","AppF","$firebaseArray","NgMap","$document","geoDistanceFilter",function($rootScope,$scope,$log,successAlertS,errAlertS,$firebaseAuth,$state,$q,F,$firebaseArray,NgMap,$document,geoDistanceFilter){var initiated=!1;$scope.volunteer={};var root=firebase.database().ref("/");$scope.auth=$firebaseAuth(),$scope.distanceFromMe=10,$scope.selectedDonation=!1,$scope.map;var init=function(user){user&&user.providerData&&user.providerData[0]&&"twitter.com"==user.providerData[0].providerId&&(console.log(user,"loggedIn User"),checkIfUserExist(user.uid).then(function(volunteer){volunteer?(console.log(volunteer,"volunteer existe"),$scope.volunteer=volunteer,volunteer.active&&($scope.loading=!0),$scope.volunteer.hasOwnProperty("selectedDonation")&&getSelectedDonation($scope.volunteer.selectedDonation),getMapInfo()):($scope.volunteer={registeredTovolunteer:!1,provider:"twitter",uid:user.uid,active:!1},console.log($scope.volunteer,"volunteer no existe")),initiated=!0}))},saveDonation=function(donation,successMsg){var promise=$q.defer();donation.updatedAt=moment().valueOf();var id=angular.copy(donation.$id);return delete donation.$id,delete donation.$priority,delete donation.distance,console.log(donation,id,"saving donation"),root.child("donations").child(id).set(donation).then(function(){donation.$id=id,successAlertS(successMsg),promise.resolve(!0)},function(err){errAlertS(err),promsise.reject(err)}),promise.promise},saveVolunteer=function(value,prop){return console.log(value,prop,"saving volunteer"),root.child("volunteers").child(F.user.uid).child(prop).set(value)},checkIfUserExist=function(uid){var promise=$q.defer();return root.child("volunteers").child(uid).once("value",function(snap){var volunteer=snap.val();volunteer?promise.resolve(volunteer):promise.resolve(!1)},function(err){errAlertS(err),promise.reject(err)}),promise.promise},getSelectedDonation=function(donationId){console.log("SIP",donationId),root.child("donations").child(donationId).once("value",function(snap){$scope.selectedDonation=snap.val(),$scope.selectedDonation.$id=snap.key,$scope.$apply(),"recogido"!=$scope.selectedDonation.status&&"entregando"!=$scope.selectedDonation.status||$state.go("chooseCenter")})},addMarker=function(lat,lng,name,place){var marker=new google.maps.Marker({position:new google.maps.LatLng(lat,lng),map:$scope.map,title:name});google.maps.event.addListener(marker,"click",function(){$scope.selectDonation(place)})},initMap=function(){F.getLocation().then(function(myPosition){var latlng=new google.maps.LatLng(myPosition.latitude,myPosition.longitude),myOptions={zoom:14,center:latlng,mapTypeId:google.maps.MapTypeId.TERRAIN};$scope.map=new google.maps.Map(document.getElementById("map"),myOptions),$scope.nearestDonations=geoDistanceFilter($scope.donationsAvailable,myPosition,$scope.distanceFromMe);for(var d in $scope.nearestDonations){var donation=$scope.nearestDonations[d];addMarker(donation.latitude,donation.longitude,donation.name+" - "+donation.categoryOfDonations,donation)}$scope.loading=!1,google.maps.event.addListenerOnce($scope.map,"idle",function(){google.maps.event.trigger($scope.map,"resize"),$scope.map.setCenter(latlng)})})},getMapInfo=function(){$scope.donationsAvailable=$firebaseArray(root.child("donations").orderByChild("status").equalTo("esperando")),$scope.donationsAvailable.$loaded().then(function(){initMap()})};$scope.save=function(){$log.debug("saving",$scope.volunteer),$scope.volunteer.registeredTovolunteer=!0,$scope.volunteer.updatedAt=moment().valueOf(),root.child("volunteers").child($scope.volunteer.uid).set($scope.volunteer).then(function(){successAlertS("Gracias por registrarte como voluntario, en cuanto nos sea posible nos pondremos en contacto contigo")},errAlertS)},$scope.pickupDonation=function(){$scope.selectedDonation.status="recogido",$scope.selectedDonation.pickedBy=F.user.uid,saveDonation($scope.selectedDonation,"Gracias!! Se recogiste la donación, ahora solo debes llevarla a un centro de acopio").then(function(){$state.go("chooseCenter")})},$scope.cancelPickup=function(){$scope.selectedDonation.status="esperando",$scope.selectedDonation.deliverAt=null,saveVolunteer(null,"selectedDonation").then(function(){saveDonation($scope.selectedDonation,"Se canceló que recogieras esa donación").then(function(){$scope.selectedDonation=!1})})},$scope.selectDonation=function(point){$scope.loading=!0,console.log(point,"select point"),$scope.selectedDonation=point,$scope.selectedDonation.status="recogiendo",saveVolunteer($scope.selectedDonation.$id,"selectedDonation").then(function(){saveDonation($scope.selectedDonation,"Escogiste una donación").then(function(){$scope.loading=!1})})},$rootScope.$on("loggedIn",function(event,logged){$log.debug(logged,"loggedIn?"),logged&&!initiated&&("twitter.com"!==F.user.providerData[0].providerId?$state.go("home"):init(F.user))}),F.user&&!initiated&&("twitter.com"!==F.user.providerData[0].providerId?$state.go("home"):init(F.user));var initWatcher=$scope.$watch("F.user.providerData[0].providerId",function(providerId){providerId&&("twitter.com"!==providerId?$state.go("home"):(init(F.user),initWatcher()))})}]),angular.module("app").controller("CrudsCtrl",["$rootScope","$scope","$firebaseArray","$log","$mdDialog","$localStorage","AppF","errAlertS","successAlertS","slugifyFilter",function($rootScope,$scope,$firebaseArray,$log,$mdDialog,$localStorage,F,errAlert,successAlert,slugify){var root=firebase.database().ref("/"),storageRef=firebase.storage().ref(),initiated=!1;$scope.cruds=[];var init=function(){$scope.loadAll(),$scope.newItem=!1,$scope.uploadImage=!1,initiated=!0};$scope.loadAll=function(){var crudsQ=root.child("cruds");$scope.cruds=$firebaseArray(crudsQ),$scope.cruds.$loaded(function(cruds){$scope.cruds=cruds,$log.debug("Loaded",$scope.cruds)})},$scope.add=function(crud){$log.debug("creating: ",crud),crud.created_on=firebase.database.ServerValue.TIMESTAMP,crud.images={portada:!1,logo:!1},$scope.cruds.$add(crud).then(function(){F.counter.cruds=F.counter.cruds+1,F.counter.$save(),successAlert("Crud Creada"),$scope.newItem=!1,$mdDialog.cancel()},errAlert)},$scope.save=function(crud){$log.debug("saving: ",crud),crud.updated_on=firebase.database.ServerValue.TIMESTAMP,$scope.cruds.$save(crud).then(function(){successAlert("Crud Guardado")},errAlert)},$scope.remove=function(crud){return $log.debug("removing: ",crud),$scope.cruds.$remove(crud)},$scope.upload=function(files,whatImage,crud){var file=files[0].lfFile,imagesRef=storageRef.child("cruds/"),fileName=slugify(crud.name)+"_"+whatImage+"_.jpg",spaceRef=imagesRef.child(fileName),uploadTask=(spaceRef.fullPath,spaceRef.put(file));$scope.progress=0,uploadTask.on("state_changed",function(snapshot){switch($scope.progress=snapshot.bytesTransferred/snapshot.totalBytes*100,$log.info("Upload is "+$scope.progress+"% done"),snapshot.state){case firebase.storage.TaskState.PAUSED:$log.debug("Upload is paused");break;case firebase.storage.TaskState.RUNNING:$log.debug("Upload is running")}},errAlert,function(){crud.images[whatImage]=uploadTask.snapshot.downloadURL,$scope.cruds.$save(crud).then(function(){successAlert("Se subió el archivo correctamente")},errAlert)}),$log.debug("uploading: ",crud,whatImage,file)},$scope.removeUpload=function(crud,whatImage){var fileName=slugify(crud.name)+"_"+whatImage+"_.jpg",desertRef=storageRef.child("cruds/"+fileName);desertRef["delete"]().then(function(){crud.images[whatImage]=!1,$scope.cruds.$save(crud).then(function(){successAlert("Se borró el archivo correctamente")},errAlert)})["catch"](function(err){crud.images[whatImage]=!1,$scope.cruds.$save(crud).then(function(){successAlert("Se borró el archivo correctamente")},errAlert)})},$scope.cancelUpload=function(uploadTask){uploadTask.cancel()},$scope.showAddDialog=function(event){$scope.newItem=!0,$scope.crud={},$mdDialog.show({scope:$scope,preserveScope:!0,controller:"DialogCtrl",templateUrl:"partials/admin/dialogs/cruds.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0})},$scope.showSaveDialog=function(event,crud){$scope.crud=crud,$mdDialog.show({scope:$scope,preserveScope:!0,controller:"DialogCtrl",templateUrl:"partials/admin/dialogs/cruds.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0})},$scope.showRemoveDialog=function(event){$scope.crudsToBeRemoved=F.getSelected($scope.cruds);var msg=F.safeRemove?"Podrá recuperar sus datos en la papelera hasta por "+F.recycleDays+" días.":"No podrá recuperar sus datos.";$mdDialog.show($mdDialog.confirm({onComplete:function(){var $dialog=angular.element(document.querySelector("md-dialog")),$actionsSection=$dialog.find("md-dialog-actions"),$cancelButton=$actionsSection.children()[0],$confirmButton=$actionsSection.children()[1];angular.element($confirmButton).addClass("md-raised md-warn"),angular.element($cancelButton).addClass("md-raised")}}).title("Remover "+$scope.crudsToBeRemoved.length+" cruds?").textContent(msg).ariaLabel("Lucky day").targetEvent(event).ok("Eliminar").cancel("Cancelar")).then(function(){var count=0;$log.debug("Deleting: ",$scope.crudsToBeRemoved),angular.forEach($scope.crudsToBeRemoved,function(crud){F.safeRemove||$scope.remove(crud).then(function(){F.counter.cruds=F.counter.cruds-1,F.counter.$save(),count++,count==$scope.crudsToBeRemoved.length&&successAlert("Se borraron "+count+" cruds")})})})},$rootScope.$on("loggedIn",function(event,logged){$log.debug(logged,"loggedIn?"),logged&&init()}),F.user&&!initiated&&init()}]),angular.module("app").controller("DialogCtrl",["$scope","$mdDialog",function($scope,$mdDialog){$scope.hide=function(){$mdDialog.hide()},$scope.cancel=function(){$mdDialog.cancel()}}]),angular.module("app").controller("DonateCtrl",["$rootScope","$scope","errAlertS","successAlertS","NgMap",function($rootScope,$scope,errAlertS,successAlertS,NgMap){var initiated=!1;$scope.map;var root=firebase.database().ref("/");$scope.donator={},$scope.donationSent=!1;var init=function(){initiated=!0},thanks=function(){$scope.donationSent=!0,$scope.$apply()};NgMap.getMap("map").then(function(evtMap){$scope.map=evtMap}),$scope.getGrabPosition=function(){var position=$scope.map.markers[0].getPosition();return{lat:position.lat(),lng:position.lng()}},$scope.save=function(){var position=$scope.getGrabPosition();$scope.donator.createdAt=moment().valueOf(),$scope.donator.latitude=position.lat,$scope.donator.longitude=position.lng,$scope.donator.status="esperando",console.log("saving",$scope.donator),root.child("donations").push($scope.donator).then(function(){thanks()},errAlertS)},$scope.ubicateMe=function(){console.log("ubicating me")},$scope.getCoords=function(){var value24=document.getElementById("addressInput").value;NgMap.getGeoLocation(value24).then(function(latlng){$scope.map.markers[0].setPosition(latlng),$scope.map.setCenter(latlng)})},init()}]),angular.module("app").controller("GeneralCtrl",["$rootScope","$scope","$http","$sessionStorage","AppF",function($rootScope,$scope,$http,$sessionStorage,AppF){$rootScope.F=AppF;var init=function(){};init()}]),angular.module("app").controller("HomeCtrl",["$rootScope","$scope",function($rootScope,$scope){var initiated=!1,init=function(){initiated=!0,console.log("Home Ctrl initiated")};init()}]),angular.module("app").controller("MenuCtrl",["$scope","$log","$mdSidenav","$timeout","$rootScope","AppF","$window",function($scope,$log,$mdSidenav,$timeout,$rootScope,AppF,$window){$log.debug("inside MenuCtrl"),$scope.toggleLeft=function(){$mdSidenav("left").toggle().then(function(){$log.debug("toggle is done")})},$rootScope.F=AppF,$scope.close=function(){$mdSidenav("left").close().then(function(){$log.debug("close LEFT is done")})},$scope.triggerMenu=function(ev){angular.element(".nav-trigger").toggleClass("active"),angular.element(".nav").toggleClass("mobile-nav-active")},$window.onload=function(event){toogleMenu()},$window.onresize=function(event){toogleMenu()};var toogleMenu=function(){var width=$window.innerWidth;width>=769?(console.log("big device"),angular.element(".nav").removeClass("mobile-nav-active")):console.log("small device")}}]),angular.module("app").controller("ToastCtrl",["$scope","$mdToast",function($scope,$mdToast){$scope.closeToast=function(){$mdToast.hide()}}]),angular.module("app").controller("VolunteerCtrl",["$rootScope","$scope","$log","successAlertS","errAlertS","$firebaseAuth","$state","$q","AppF","$firebaseArray","NgMap","$document","geoDistanceFilter",function($rootScope,$scope,$log,successAlertS,errAlertS,$firebaseAuth,$state,$q,F,$firebaseArray,NgMap,$document,geoDistanceFilter){var initiated=!1;$scope.volunteer={};var root=firebase.database().ref("/");
$scope.auth=$firebaseAuth();var init=function(user){user&&user.providerData&&user.providerData[0]&&"twitter.com"==user.providerData[0].providerId&&(console.log(user,"loggedIn User"),checkIfUserExist(user.uid).then(function(volunteer){volunteer?(console.log(volunteer,"volunteer existe"),$scope.volunteer=volunteer,$scope.volunteer.hasOwnProperty("selectedDonation")?getSelectedDonation($scope.volunteer.selectedDonation):$state.go("chooseDonation")):($scope.volunteer={registeredTovolunteer:!1,provider:"twitter",uid:user.uid,active:!1},console.log($scope.volunteer,"volunteer no existe"),console.log("se está en el paso correcto")),initiated=!0}))},checkIfUserExist=function(uid){var promise=$q.defer();return root.child("volunteers").child(uid).once("value",function(snap){var volunteer=snap.val();volunteer?promise.resolve(volunteer):promise.resolve(!1)},function(err){errAlertS(err),promise.reject(err)}),promise.promise},getSelectedDonation=function(donationId){console.log("getSelectedDonation",donationId),root.child("donations").child(donationId).once("value",function(snap){$scope.selectedDonation=snap.val(),$scope.selectedDonation.$id=snap.key,$scope.$apply(),"esperando"==$scope.selectedDonation.status||"recogiendo"==$scope.selectedDonation.status?$state.go("chooseDonation"):"recogido"!=$scope.selectedDonation.status&&"entregando"!=$scope.selectedDonation.status||$state.go("chooseCenter")})};$scope.save=function(){$log.debug("saving",$scope.volunteer),$scope.volunteer.registeredTovolunteer=!0,$scope.volunteer.updatedAt=moment().valueOf(),root.child("volunteers").child($scope.volunteer.uid).set($scope.volunteer).then(function(){successAlertS("Gracias por registrarte como voluntario, en cuanto nos sea posible nos pondremos en contacto contigo"),$state.go("chooseDonation")},errAlertS)},$scope.loginWithTwitter=function(){$scope.auth.$signInWithRedirect("twitter")["catch"](errAlertS)},$rootScope.$on("loggedIn",function(event,logged){$log.debug(logged,"loggedIn?"),logged&&!initiated&&("twitter.com"!==F.user.providerData[0].providerId?$state.go("home"):init(F.user))}),F.user&&!initiated&&("twitter.com"!==F.user.providerData[0].providerId?$state.go("home"):init(F.user))}]),angular.module("app").directive("frontMenu",[function(){return{restrict:"A",scope:!0,transclude:!0,templateUrl:"partials/front-menu.html",link:function(scope,ele,attrs){scope.active=attrs.active,attrs.$observe("active",function(){scope.active=attrs.active})}}}]),angular.module("app").directive("menuLinks",["$state",function($state){return{restrict:"A",templateUrl:"partials/menu-links.html",link:function(scope,ele,attrs,ctrl){scope.isOpen=function(state){return $state.includes(state)}}}}]),angular.module("app").directive("menuSidebarLeft",[function(){return{restrict:"E",scope:!0,transclude:!0,templateUrl:"partials/menu-sidebar-left.html"}}]),angular.module("app").directive("partialLoading",[function(){return{restrict:"A",scope:!0,transclude:!0,templateUrl:"partials/partial-loading.html"}}]),angular.module("app").directive("searchObjectsBar",[function(){return{restrict:"A",replace:!0,scope:{search:"="},transclude:!0,templateUrl:"partials/search-objects-bar.html"}}]),angular.module("app").directive("titleObjectsBar",[function(){return{restrict:"A",replace:!0,scope:{objects:"=",title:"="},transclude:!0,templateUrl:"partials/title-objects-bar.html"}}]),angular.module("app").factory("AppF",["$state","errAlertS","$q",function($state,errAlertS,$q){var obj={paginate:5,recycleDays:30,inModule:"site",user:!1,contactFormUrl:"/contacto.php","goto":function(state){$state.go(state)},getSelected:function(array){var selected=[];for(var a in array)array[a].selected&&selected.push(array[a]);return selected},somethingIsSelected:function(objects){for(var a in objects)if(objects[a].selected)return!0;return!1},getLocation:function(){var promise=$q.defer();return obj.myPosition?promise.resolve(obj.myPosition):navigator.geolocation?navigator.geolocation.getCurrentPosition(function(position){obj.myPosition={latitude:position.coords.latitude,longitude:position.coords.longitude},console.log(position,"ALMENOS"),promise.resolve(obj.myPosition)},function(err){promise.reject(err)}):promise.reject("Geolocation no está soportada en su navegador."),promise.promise}};return obj}]),Number.prototype.toRad=function(){return this*Math.PI/180},angular.module("app").filter("geoDistance",[function(){return function(points,myLocation,distance){function dist(meLocation,destination){var destinationLat=destination.latitude,destinationLong=destination.longitude,sourceLat=meLocation.latitude,sourceLong=meLocation.longitude,earthRadius=6371,latitudeDiff=destinationLat-sourceLat,dLat=latitudeDiff.toRad(),longitudeDiff=destinationLong-sourceLong,dLon=longitudeDiff.toRad(),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(sourceLat.toRad())*Math.cos(destinationLat.toRad())*Math.sin(dLon/2)*Math.sin(dLon/2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=earthRadius*c,m=.621371*d,obj={kilometers:d,miles:m};return obj}var nearestPoints=[];distance=parseInt(distance)||10;for(var t=0;t<points.length;t++){points[t].distance=dist(myLocation,points[t]).kilometers;var isInRadio=points[t].distance<1e3*distance;isInRadio&&nearestPoints.push(points[t])}return nearestPoints}}]),angular.module("app").filter("howManyImages",[function(){return function(images){var howMany=0;return images&&(images.logo?images.portada&&(howMany=2):images.portada&&(howMany=1)),howMany}}]),angular.module("app").filter("randomKeyOfArray",[function(){return function(array){return Math.floor(Math.random()*array.length+1)-1}}]),angular.module("app").filter("showingWhatPaginate",[function(){return function(page,paginate,array,total){var firstRecord,lastRecord;firstRecord=page>1?(page-1)*paginate+1:1,lastRecord=page>1?firstRecord+(array.length<paginate?array.length:paginate)-1:array.length<paginate?array.length:paginate;var final=firstRecord+"-"+lastRecord+" de "+total;return final}}]),angular.module("app").filter("shuffleArray",[function(){return function(array){for(var t,i,m=array.length;m;)i=Math.floor(Math.random()*m--),t=array[m],array[m]=array[i],array[i]=t;return array}}]),angular.module("app").service("errAlertS",["$mdToast","$log",function($mdToast,$log){return function(err){if(angular.isDefined(err.code))switch(err.code){case"EMAIL_TAKEN":err="El correo ya está en uso.";break;case"PERMISSION_DENIED":err="Permiso Denegado: El objeto está repetido o no cumple con las validaciones";break;case"INVALID_EMAIL":err="El correo no es válido";break;case"auth/user-not-found":err="Usuario no encontrado";break;case"auth/wrong-password":err="Password incorrecto";break;case"auth/too-many-requests":err="Se ha intentado entrar demaciadas veces con un password incorrecto. Hemos bloqueado toda petición de éste dispositivo, favor de intentar más tarde";break;case"auth/network-request-failed":err="Error de conexión, favor de intentar más tarde";break;case"storage/unauthorized":err="No autorizado";break;case"storage/canceled":err="Cancelado";break;case"storage/unknown":err="Problemas de conexión, favor de intentar más tarde";break;case"storage/invalid-argument":err="Archivo inválido"}$log.error(err);var toast={position:"bottom right",hideDelay:0,template:'<md-toast class="error"><span flex>'+err+'</span><md-button class="md-icon-button" ng-click="closeToast()"><md-icon style="color: white" aria-label="hey" class="material-icons step">clear</md-icon></md-button></md-toast>',controller:"ToastCtrl"};$mdToast.show(toast)}}]),angular.module("app").service("infoAlertS",["$mdToast","$log",function($mdToast,$log){return function(msg){$log.info(msg);var toast={position:"bottom right",hideDelay:5e3,template:"<md-toast><span flex>"+msg+'</span><md-button class="md-icon-button" ng-click="closeToast()"><md-icon style="color: white" aria-label="hey" class="material-icons step">clear</md-icon></md-button></md-toast>',controller:"ToastCtrl"};$mdToast.show(toast)}}]),angular.module("app").service("successAlertS",["$mdToast","$log",function($mdToast,$log){return function(msg){$log.log(msg);var toast={position:"bottom right",hideDelay:5e3,template:'<md-toast class="success"><span flex>'+msg+'</span><md-button class="md-icon-button" ng-click="closeToast()"><md-icon style="color: white" aria-label="hey" class="material-icons step">clear</md-icon></md-button></md-toast>',controller:"ToastCtrl"};$mdToast.show(toast)}}]);